# Forgejo CI/CD Infrastructure
# Separate from main application for flexibility
#
# Usage:
#   docker compose -f docker-compose.ci.yml up -d
#
# Access:
#   - Forgejo Web UI: http://localhost:3000
#   - First-time setup: Create admin account at http://localhost:3000/install

services:
  # Forgejo - Lightweight GitHub alternative with integrated CI/CD
  forgejo:
    image: codeberg.org/forgejo/forgejo:9
    container_name: forgejo
    environment:
      - USER_UID=1000
      - USER_GID=1000
      # Enable Actions (CI/CD)
      - FORGEJO__actions__ENABLED=true
      - FORGEJO__actions__DEFAULT_ACTIONS_URL=https://github.com
      # Server configuration
      - FORGEJO__server__ROOT_URL=http://localhost:3000
      - FORGEJO__server__SSH_PORT=222
      - FORGEJO__server__SSH_LISTEN_PORT=22
      # Database (SQLite for simplicity)
      - FORGEJO__database__DB_TYPE=sqlite3
      # Security
      - FORGEJO__security__INSTALL_LOCK=false
      # Repository settings
      - FORGEJO__repository__DEFAULT_BRANCH=main
    restart: unless-stopped
    volumes:
      - forgejo_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"   # Web UI
      - "222:22"      # SSH (use 222 to avoid conflict with host SSH)
    networks:
      - forgejo-net

  # Forgejo Runner - Executes CI/CD jobs
  # NOTE: Runner requires registration after Forgejo is running.
  # See docs/FORGEJO_CI_SETUP.md for instructions.
  forgejo-runner:
    image: code.forgejo.org/forgejo/runner:6.2.0
    container_name: forgejo-runner
    # Command will be set after registration
    command: daemon
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    restart: unless-stopped
    depends_on:
      - forgejo
    volumes:
      - forgejo_runner_data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - forgejo-net
    # Runner needs to access Docker to run CI jobs
    user: "0:0"

networks:
  forgejo-net:
    driver: bridge

volumes:
  forgejo_data:
    driver: local
  forgejo_runner_data:
    driver: local
