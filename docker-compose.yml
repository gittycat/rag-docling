services:
  # FastAPI Web Application - Public facing service
  fastapi_web_app:
    build:
      context: .
      dockerfile: ./services/fastapi_web_app/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - RAG_SERVER_URL=http://rag-server:8001
    depends_on:
      - rag-server
    networks:
      - public
      - private
    volumes:
      - ./data/indexed_documents:/app/documents:ro
    secrets:
      - ollama_config

  # RAG Server - Core processing service
  rag-server:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    environment:
      - CHROMADB_URL=http://chromadb:8000
      - OLLAMA_URL=http://host.docker.internal:11434
      - EMBEDDING_MODEL=qwen3-embedding:8b
      - LLM_MODEL=gemma3:4b
      - PROMPT_STRATEGY=comprehensive  # Options: fast, balanced, precise, comprehensive
      - ENABLE_RERANKER=true
      - RERANKER_MODEL=cross-encoder/ms-marco-MiniLM-L-6-v2
      - RERANKER_SIMILARITY_THRESHOLD=0.65
      - RETRIEVAL_TOP_K=10
      - REDIS_URL=redis://redis:6379/0
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - chromadb
    networks:
      - private
      - public
    volumes:
      - ./data/indexed_documents:/app/documents
      - shared_temp:/tmp/shared
    secrets:
      - ollama_config

  # ChromaDB Vector Database (private network only)
  chromadb:
    image: chromadb/chroma:latest
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    volumes:
      - chroma_db_data:/chroma/chroma
    networks:
      - private
    restart: unless-stopped

  # Redis - Message broker and result backend for Celery
  redis:
    image: redis:7-alpine
    networks:
      - private
    restart: unless-stopped

  # Celery Worker - Async document processing
  celery-worker:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    command: [".venv/bin/celery", "-A", "celery_app", "worker", "--loglevel=info", "--concurrency=2"]
    environment:
      - CHROMADB_URL=http://chromadb:8000
      - OLLAMA_URL=http://host.docker.internal:11434
      - EMBEDDING_MODEL=qwen3-embedding:8b
      - LLM_MODEL=gemma3:4b
      - PROMPT_STRATEGY=comprehensive
      - ENABLE_RERANKER=true
      - RERANKER_MODEL=cross-encoder/ms-marco-MiniLM-L-6-v2
      - RERANKER_SIMILARITY_THRESHOLD=0.65
      - RETRIEVAL_TOP_K=10
      - REDIS_URL=redis://redis:6379/0
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
      - chromadb
    networks:
      - private
      - public
    volumes:
      - ./data/indexed_documents:/app/documents
      - shared_temp:/tmp/shared
    secrets:
      - ollama_config

# Network configuration for security isolation
networks:
  public:
    driver: bridge
  private:
    driver: bridge
    internal: true

# Persistent volumes
volumes:
  chroma_db_data:
    driver: local
  shared_temp:
    driver: local

# Secrets management
secrets:
  ollama_config:
    file: ./secrets/ollama_config.env 