services:
  # FastAPI Web Application - Public facing service
  fastapi_web_app:
    build:
      context: .
      dockerfile: ./services/fastapi_web_app/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - RAG_SERVER_URL=http://rag-server:8001
    depends_on:
      - rag-server
    networks:
      - public
      - private
    volumes:
      - ./data/indexed_documents:/app/documents:ro
    secrets:
      - ollama_config

  # RAG Server - Core processing service
  rag-server:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    environment:
      - CHROMADB_URL=http://chromadb:8000
      - OLLAMA_URL=http://host.docker.internal:11434
      - EMBEDDING_MODEL=nomic-embed-text
      - LLM_MODEL=llama3.2:latest
      - PROMPT_STRATEGY=balanced  # Options: fast, balanced, precise, comprehensive
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - chromadb
    networks:
      - private
      - public
    volumes:
      - ./data/indexed_documents:/app/documents
    secrets:
      - ollama_config

  # ChromaDB Vector Database (private network only)
  chromadb:
    image: chromadb/chroma:latest
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    volumes:
      - chroma_db_data:/chroma/chroma
    networks:
      - private
    restart: unless-stopped

# Network configuration for security isolation
networks:
  public:
    driver: bridge
  private:
    driver: bridge
    internal: true

# Persistent volumes
volumes:
  chroma_db_data:
    driver: local

# Secrets management
secrets:
  ollama_config:
    file: ./secrets/ollama_config.env 